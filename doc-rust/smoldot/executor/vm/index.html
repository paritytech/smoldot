<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="General-purpose WebAssembly virtual machine."><meta name="keywords" content="rust, rustlang, rust-lang, vm"><title>smoldot::executor::vm - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Regular-1f7d512b176f0f72.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceSerif4-Bold-124a1ca42af929b6.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-6827029ac823cab7.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../../../static.files/light-ebce58d0a40c3431.css"><link rel="stylesheet" disabled href="../../../static.files/dark-f23faae4a2daf9a6.css"><link rel="stylesheet" disabled href="../../../static.files/ayu-8af5e100b21cd173.css"><script id="default-settings" ></script><script src="../../../static.files/storage-d43fa987303ecbbb.js"></script><script defer src="../../../static.files/main-c55e1eb52e1886b4.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../smoldot/index.html"><div class="logo-container"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../smoldot/index.html"><div class="logo-container"><img class="rust-logo" src="../../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></div></a><h2 class="location"><a href="#">Module vm</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../static.files/wheel-5ec35bf9ca753509.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1 class="fqn">Module <a href="../../index.html">smoldot</a>::<wbr><a href="../index.html">executor</a>::<wbr><a class="mod" href="#">vm</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../../src/smoldot/executor/vm.rs.html#18-757">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>General-purpose WebAssembly virtual machine.</p>
<p>Contains code related to running a WebAssembly virtual machine. Contrary to
(<code>HostVm</code>)<a href="../host/enum.HostVm.html" title="super::host::HostVm"><code>super::host::HostVm</code></a>, this module isn’t aware of any of the host
functions available to Substrate runtimes. It only contains the code required to run a virtual
machine, with some adjustments explained below.</p>
<h2 id="usage"><a href="#usage">Usage</a></h2>
<p>Call <a href="struct.VirtualMachinePrototype.html#method.new" title="VirtualMachinePrototype::new"><code>VirtualMachinePrototype::new</code></a> in order to parse and/or compile some WebAssembly code.
One of the parameters of this function is a function that is passed the name of functions
imported by the Wasm code, and must return an opaque <code>usize</code>. This <code>usize</code> doesn’t have any
meaning, but will later be passed back to the user through <a href="enum.ExecOutcome.html#variant.Interrupted.field.id" title="ExecOutcome::Interrupted::id"><code>ExecOutcome::Interrupted::id</code></a>
when the corresponding function is called.</p>
<p>The WebAssembly code can export functions in two different ways:</p>
<ul>
<li>Some functions are exported through an <code>(export)</code> statement.
See <a href="https://webassembly.github.io/spec/core/bikeshed/#export-section%E2%91%A0">https://webassembly.github.io/spec/core/bikeshed/#export-section%E2%91%A0</a>.</li>
<li>Some functions are stored in a global table called <code>__indirect_function_table</code>, and are
later referred to by their index in this table. This is how the concept of “function
pointers” commonly found in low-level programming languages is translated in WebAssembly.</li>
</ul>
<blockquote>
<p><strong>Note</strong>: At the time of writing, it isn’t possible to call the second type of functions yet.</p>
</blockquote>
<p>Use <a href="struct.VirtualMachinePrototype.html#method.start" title="VirtualMachinePrototype::start"><code>VirtualMachinePrototype::start</code></a> in order to start executing a function exported through
an <code>(export)</code> statement.</p>
<p>Call <a href="struct.VirtualMachine.html#method.run" title="VirtualMachine::run"><code>VirtualMachine::run</code></a> on the <a href="struct.VirtualMachine.html" title="VirtualMachine"><code>VirtualMachine</code></a> returned by <code>start</code> in order to run the
WebAssembly code. The <code>run</code> method returns either if the function being called returns, or if
the WebAssembly code calls a host function. In the latter case, <a href="enum.ExecOutcome.html#variant.Interrupted" title="ExecOutcome::Interrupted"><code>ExecOutcome::Interrupted</code></a>
is returned and the virtual machine is now paused. Once the logic of the host function has
been executed, call <code>run</code> again, passing the return value of that host function.</p>
<h2 id="about-__indirect_function_table"><a href="#about-__indirect_function_table">About <code>__indirect_function_table</code></a></h2>
<p>At initialization, the virtual machine will look for a table named <code>__indirect_function_table</code>.
If present, this table is expected to contain functions. These functions can then be referred
to by their index in this table. This is how the concept of “function pointers” commonly found
in programming languages is translated in WebAssembly.</p>
<blockquote>
<p><strong>Note</strong>: When compiling C, C++, Rust, or similar languages to WebAssembly, one must pass
the <code>--export-table</code> option to the LLVM linker in order for this symbol to be
exported.</p>
</blockquote>
<h2 id="about-imported-vs-exported-memory"><a href="#about-imported-vs-exported-memory">About imported vs exported memory</a></h2>
<p>WebAssembly supports, in theory, addressing multiple different memory objects. The WebAssembly
module can declare memory in two ways:</p>
<ul>
<li>Either by exporting a memory object in the <code>(export)</code> section under the name <code>memory</code>.</li>
<li>Or by importing a memory object in its <code>(import)</code> section.</li>
</ul>
<p>The virtual machine in this module supports both variants. However, no more than one memory
object can be exported or imported, and it is illegal to not use any memory.</p>
<p>The first variant used to be the default model when compiling to WebAssembly, but the second
variant (importing memory objects) is preferred nowadays.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.HeapPages.html" title="smoldot::executor::vm::HeapPages struct">HeapPages</a></div><div class="item-right docblock-short">Number of heap pages available to the Wasm code.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Module.html" title="smoldot::executor::vm::Module struct">Module</a></div><div class="item-right docblock-short">Compiled Wasm code.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.ModuleError.html" title="smoldot::executor::vm::ModuleError struct">ModuleError</a></div><div class="item-right docblock-short">Opaque error indicating an error while parsing or compiling the WebAssembly code.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.OutOfBoundsError.html" title="smoldot::executor::vm::OutOfBoundsError struct">OutOfBoundsError</a></div><div class="item-right docblock-short">Error while reading memory.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Signature.html" title="smoldot::executor::vm::Signature struct">Signature</a></div><div class="item-right docblock-short">Low-level Wasm function signature.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.Trap.html" title="smoldot::executor::vm::Trap struct">Trap</a></div><div class="item-right docblock-short">Opaque error that happened during execution, such as an <code>unreachable</code> instruction.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.UnsupportedTypeError.html" title="smoldot::executor::vm::UnsupportedTypeError struct">UnsupportedTypeError</a></div><div class="item-right docblock-short">Error used in the conversions between VM implementation and the public API.</div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.VirtualMachine.html" title="smoldot::executor::vm::VirtualMachine struct">VirtualMachine</a></div></div><div class="item-row"><div class="item-left module-item"><a class="struct" href="struct.VirtualMachinePrototype.html" title="smoldot::executor::vm::VirtualMachinePrototype struct">VirtualMachinePrototype</a></div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ExecHint.html" title="smoldot::executor::vm::ExecHint enum">ExecHint</a></div><div class="item-right docblock-short">Hint used by the implementation to decide which kind of virtual machine to use.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ExecOutcome.html" title="smoldot::executor::vm::ExecOutcome enum">ExecOutcome</a></div><div class="item-right docblock-short">Outcome of the <a href="struct.VirtualMachine.html#method.run"><code>run</code></a> function.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.GlobalValueErr.html" title="smoldot::executor::vm::GlobalValueErr enum">GlobalValueErr</a></div><div class="item-right docblock-short">Error that can happen when calling <a href="struct.VirtualMachinePrototype.html#method.global_value" title="VirtualMachinePrototype::global_value"><code>VirtualMachinePrototype::global_value</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.NewErr.html" title="smoldot::executor::vm::NewErr enum">NewErr</a></div><div class="item-right docblock-short">Error that can happen when initializing a <a href="struct.VirtualMachinePrototype.html" title="VirtualMachinePrototype"><code>VirtualMachinePrototype</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.RunErr.html" title="smoldot::executor::vm::RunErr enum">RunErr</a></div><div class="item-right docblock-short">Error that can happen when resuming the execution of a function.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.StartErr.html" title="smoldot::executor::vm::StartErr enum">StartErr</a></div><div class="item-right docblock-short">Error that can happen when calling <a href="struct.VirtualMachinePrototype.html#method.start" title="VirtualMachinePrototype::start"><code>VirtualMachinePrototype::start</code></a>.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.ValueType.html" title="smoldot::executor::vm::ValueType enum">ValueType</a></div><div class="item-right docblock-short">Type of a value passed as parameter or returned by a function.</div></div><div class="item-row"><div class="item-left module-item"><a class="enum" href="enum.WasmValue.html" title="smoldot::executor::vm::WasmValue enum">WasmValue</a></div><div class="item-right docblock-short">Value that a Wasm function can accept or produce.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="smoldot" data-themes="" data-resource-suffix="" data-rustdoc-version="1.67.1 (d5a82bbd2 2023-02-07)" data-search-js="search-444266647c4dba98.js" data-settings-js="settings-bebeae96e00e4617.js" data-settings-css="settings-af96d9e2fc13e081.css" ></div></body></html>